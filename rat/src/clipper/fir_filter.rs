use std::simd::{f32x8, num::SimdFloat};

const OVERSAMPLE_FACTOR: f32 = 8.;

pub struct FirFilter {
  buffer: Vec<f32x8>,
  coefficients: Vec<f32x8>,
  index: usize,
  mask: usize,
  prev_input: f32x8,
}

impl FirFilter {
  pub fn new(coefficients: Vec<f32x8>) -> Self {
    let length = coefficients.len();
    debug_assert!(length.is_power_of_two());

    Self {
      buffer: vec![f32x8::splat(0.); length],
      coefficients,
      index: 0,
      mask: length - 1,
      prev_input: f32x8::splat(0.),
    }
  }

  pub fn upsample(&mut self, input: f32) -> f32x8 {
    self.write(f32x8::splat(input));
    (0..self.buffer.len())
      .map(|i| self.buffer[(self.index + self.buffer.len() - i) & self.mask] * self.coefficients[i])
      .sum()
  }

  pub fn downsample(&mut self, input: f32x8) -> f32 {
    self.write_for_downsample(input);
    (0..self.buffer.len())
      .map(|i| {
        self.buffer[(self.index + self.buffer.len() - i) & self.mask].reverse()
          * self.coefficients[i]
      })
      .sum::<f32x8>()
      .reduce_sum()
  }

  fn write(&mut self, input: f32x8) {
    self.index = self.index + 1 & self.mask;
    self.buffer[self.index] = input;
  }

  fn write_for_downsample(&mut self, input: f32x8) {
    self.index = self.index + 1 & self.mask;
    self.buffer[self.index] = self.prev_input.shift_elements_left::<1>(input[0]);
    self.prev_input = input;
  }
}

#[cfg(test)]
mod tests {
  use super::FirFilter;
  use crate::clipper::coefficients::Coefficients;
  use std::simd::f32x8;

  fn assert_approximately_eq(left: f32, right: f32, digits: usize) {
    let tol = 10f32.powi(-(digits as i32));
    let diff = (left - right).abs();
    assert!(
      diff <= tol,
      "Values are not approximately equal: left={left}, right={right}, diff={diff}, tol={tol}"
    );
  }

  #[test]
  fn should_upsample() {
    let input = [
      0.00000000e+00,
      -1.30526192e-01,
      2.58819045e-01,
      -3.82683432e-01,
      5.00000000e-01,
      -6.08761429e-01,
      7.07106781e-01,
      -7.93353340e-01,
      8.66025404e-01,
      -9.23879533e-01,
      9.65925826e-01,
      -9.91444861e-01,
      1.00000000e+00,
      -9.91444861e-01,
      9.65925826e-01,
      -9.23879533e-01,
      8.66025404e-01,
      -7.93353340e-01,
      7.07106781e-01,
      -6.08761429e-01,
      5.00000000e-01,
      -3.82683432e-01,
      2.58819045e-01,
      -1.30526192e-01,
      1.37197580e-14,
      1.30526192e-01,
      -2.58819045e-01,
      3.82683432e-01,
      -5.00000000e-01,
      6.08761429e-01,
      -7.07106781e-01,
      7.93353340e-01,
      -8.66025404e-01,
      9.23879533e-01,
      -9.65925826e-01,
      9.91444861e-01,
      -1.00000000e+00,
      9.91444861e-01,
      -9.65925826e-01,
      9.23879533e-01,
      -8.66025404e-01,
      7.93353340e-01,
      -7.07106781e-01,
      6.08761429e-01,
      -5.00000000e-01,
      3.82683432e-01,
      -2.58819045e-01,
      1.30526192e-01,
      -2.74395161e-14,
      -1.30526192e-01,
      2.58819045e-01,
      -3.82683432e-01,
      5.00000000e-01,
      -6.08761429e-01,
      7.07106781e-01,
      -7.93353340e-01,
      8.66025404e-01,
      -9.23879533e-01,
      9.65925826e-01,
      -9.91444861e-01,
      1.00000000e+00,
      -9.91444861e-01,
      9.65925826e-01,
      -9.23879533e-01,
      8.66025404e-01,
      -7.93353340e-01,
      7.07106781e-01,
      -6.08761429e-01,
      5.00000000e-01,
      -3.82683432e-01,
      2.58819045e-01,
      -1.30526192e-01,
      1.27375647e-14,
      1.30526192e-01,
      -2.58819045e-01,
      3.82683432e-01,
      -5.00000000e-01,
      6.08761429e-01,
      -7.07106781e-01,
      7.93353340e-01,
      -8.66025404e-01,
      9.23879533e-01,
      -9.65925826e-01,
      9.91444861e-01,
      -1.00000000e+00,
      9.91444861e-01,
      -9.65925826e-01,
      9.23879533e-01,
      -8.66025404e-01,
      7.93353340e-01,
      -7.07106781e-01,
      6.08761429e-01,
      -5.00000000e-01,
      3.82683432e-01,
      -2.58819045e-01,
      1.30526192e-01,
    ];
    let expected_output = [
      f32x8::from_array([0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]),
      f32x8::from_array([
        -0.00018125087080989033,
        -0.0005082405987195671,
        -0.0009984946809709072,
        -0.0017157155089080334,
        -0.002673513488844037,
        -0.003877210896462202,
        -0.005301148165017366,
        -0.006894206628203392,
      ]),
      f32x8::from_array([
        -0.008215604349970818,
        -0.009230311028659344,
        -0.009779478423297405,
        -0.00960517581552267,
        -0.008553207851946354,
        -0.006504489108920097,
        -0.00343289109878242,
        0.0005941205890849233,
      ]),
      f32x8::from_array([
        0.004867148585617542,
        0.009211241267621517,
        0.013208343647420406,
        0.0162480678409338,
        0.017847303301095963,
        0.017573324963450432,
        0.015155506320297718,
        0.010511601343750954,
      ]),
      f32x8::from_array([
        0.004488014150410891,
        -0.002664624247699976,
        -0.01027256716042757,
        -0.01731511391699314,
        -0.022862941026687622,
        -0.02600790001451969,
        -0.02604551985859871,
        -0.022547638043761253,
      ]),
      f32x8::from_array([
        -0.016303561627864838,
        -0.0074930316768586636,
        0.0030565359629690647,
        0.013961691409349442,
        0.023831607773900032,
        0.031211834400892258,
        0.03484698012471199,
        0.03381573036313057,
      ]),
      f32x8::from_array([
        0.028676539659500122,
        0.01938900724053383,
        0.0068051014095544815,
        -0.007423583883792162,
        -0.021488850936293602,
        -0.03338449075818062,
        -0.04125099629163742,
        -0.043582696467638016,
      ]),
      f32x8::from_array([
        -0.040573447942733765,
        -0.031839072704315186,
        -0.018133040517568588,
        -0.001267491839826107,
        0.01660437323153019,
        0.03295913338661194,
        0.045326344668865204,
        0.051571495831012726,
      ]),
      f32x8::from_array([
        0.05142989382147789,
        0.044082485139369965,
        0.030080093070864677,
        0.011291452683508396,
        -0.009867940098047256,
        -0.03041493147611618,
        -0.047293033450841904,
        -0.05773079767823219,
      ]),
      f32x8::from_array([
        -0.060945507138967514,
        -0.05562383681535721,
        -0.04203249141573906,
        -0.02200397476553917,
        0.0018672546138986945,
        0.026207871735095978,
        0.04742177948355675,
        0.06212020292878151,
      ]),
      f32x8::from_array([
        0.06897149235010147,
        0.06613706052303314,
        0.05354057624936104,
        0.03289938345551491,
        0.006907995790243149,
        -0.020745402202010155,
        -0.04598604142665863,
        -0.06484851241111755,
      ]),
      f32x8::from_array([
        -0.07544474303722382,
        -0.07540446519851685,
        -0.06427013874053955,
        -0.043579310178756714,
        -0.016054153442382812,
        0.014379623346030712,
        0.04323943704366684,
        0.0660400316119194,
      ]),
      f32x8::from_array([
        0.08034859597682953,
        0.08327747881412506,
        0.07396809011697769,
        0.053727079182863235,
        0.025239123031497,
        -0.007409930229187012,
        -0.03940734267234802,
        -0.06581725925207138,
      ]),
      f32x8::from_array([
        -0.08368974179029465,
        -0.08965124189853668,
        -0.08243823051452637,
        -0.06308753043413162,
        -0.03418825566768646,
        8.983830048236996e-05,
        0.034686341881752014,
        0.06429382413625717,
      ]),
      f32x8::from_array([
        0.0854860469698906,
        0.0944494679570198,
        0.08952517062425613,
        0.0714520663022995,
        0.042672257870435715,
        0.0073647755198180676,
        -0.029248090460896492,
        -0.06157394498586655,
      ]),
      f32x8::from_array([
        -0.08576226979494095,
        -0.09761708974838257,
        -0.0951051190495491,
        -0.07864875346422195,
        -0.050497666001319885,
        -0.014767584390938282,
        0.023245202377438545,
        0.05775563418865204,
      ]),
      f32x8::from_array([
        0.08455029129981995,
        0.09911777824163437,
        0.09908110648393631,
        0.08453600853681564,
        0.05749989300966263,
        0.02195509895682335,
        -0.016816960647702217,
        -0.05293495953083038,
      ]),
      f32x8::from_array([
        -0.08189163357019424,
        -0.09892253577709198,
        -0.10136179625988007,
        -0.08897681534290314,
        -0.06351827830076218,
        -0.028766950592398643,
        0.01010098122060299,
        0.04720855876803398,
      ]),
      f32x8::from_array([
        0.07783178985118866,
        0.09703470021486282,
        0.10190815478563309,
        0.0918952077627182,
        0.06844985485076904,
        0.03508659452199936,
        -0.00321216881275177,
        -0.04067440703511238,
      ]),
      f32x8::from_array([
        -0.07244022190570831,
        -0.09348657727241516,
        -0.10071083903312683,
        -0.09324125200510025,
        -0.07221022993326187,
        -0.04080589488148689,
        -0.0037316035013645887,
        0.03344430401921272,
      ]),
      f32x8::from_array([
        0.06580918282270432,
        0.08833887428045273,
        0.09779033064842224,
        0.092991903424263,
        0.07473506778478622,
        0.0458269938826561,
        0.010611525736749172,
        -0.02564196102321148,
      ]),
      f32x8::from_array([
        -0.05805213004350662,
        -0.08167966455221176,
        -0.09319660067558289,
        -0.09115144610404968,
        -0.07598116993904114,
        -0.05006398260593414,
        -0.0173098836094141,
        0.017400875687599182,
      ]),
      f32x8::from_array([
        0.049301788210868835,
        0.07362289726734161,
        0.08700826019048691,
        0.0877513661980629,
        0.07592721283435822,
        0.05344436690211296,
        0.02371206507086754,
        -0.008862055838108063,
      ]),
      f32x8::from_array([
        -0.03970788046717644,
        -0.06430642306804657,
        -0.079331174492836,
        -0.08284983038902283,
        -0.07457412034273148,
        -0.055910296738147736,
        -0.02970852516591549,
        0.00017160452262032777,
      ]),
      f32x8::from_array([
        0.029434559866786003,
        0.053889643400907516,
        0.07029671967029572,
        0.07653070986270905,
        0.07194504141807556,
        0.05741959065198898,
        0.03519666567444801,
        0.008521784096956253,
      ]),
      f32x8::from_array([
        -0.018657604232430458,
        -0.04255079850554466,
        -0.06005945801734924,
        -0.06890212744474411,
        -0.0680849701166153,
        -0.05794641748070717,
        -0.04008258134126663,
        -0.017069362103939056,
      ]),
      f32x8::from_array([
        0.0075614131055772305,
        0.030483897775411606,
        0.048794567584991455,
        0.06009460985660553,
        0.06305994093418121,
        0.057481762021780014,
        0.04428267106413841,
        0.025324877351522446,
      ]),
      f32x8::from_array([
        0.0036641552578657866,
        -0.01789540983736515,
        -0.03669479116797447,
        -0.05025885999202728,
        -0.056955937296152115,
        -0.056033581495285034,
        -0.047725073993206024,
        -0.03314707800745964,
      ]),
      f32x8::from_array([
        -0.014827030710875988,
        0.005000725854188204,
        0.02396715246140957,
        0.039563167840242386,
        0.04987740144133568,
        0.053626649081707,
        0.05035088583827019,
        0.0404021218419075,
      ]),
      f32x8::from_array([
        0.025736209005117416,
        0.00797952152788639,
        -0.010829431004822254,
        -0.02819053642451763,
        -0.041945453733205795,
        -0.05030215159058571,
        -0.05211518332362175,
        -0.04696587473154068,
      ]),
      f32x8::from_array([
        -0.03620503470301628,
        -0.02082323655486107,
        -0.0024935852270573378,
        0.016335558146238327,
        0.033295806497335434,
        0.04611697047948837,
        0.05298777297139168,
        0.052726030349731445,
      ]),
      f32x8::from_array([
        0.04605438560247421,
        0.0333106629550457,
        0.015773937106132507,
        -0.004201072268188,
        -0.02407645620405674,
        -0.04114271327853203,
        -0.052953727543354034,
        -0.05758402869105339,
      ]),
      f32x8::from_array([
        -0.055115729570388794,
        -0.045228131115436554,
        -0.028784392401576042,
        -0.0080052949488163,
        0.014445152133703232,
        0.035464491695165634,
        0.05201362818479538,
        0.061456743627786636,
      ]),
      f32x8::from_array([
        0.06323403120040894,
        0.05637173354625702,
        0.041302334517240524,
        0.020074686035513878,
        -0.004566689021885395,
        -0.029179466888308525,
        -0.05018356442451477,
        -0.06427792459726334,
      ]),
      f32x8::from_array([
        -0.07027037441730499,
        -0.06655080616474152,
        -0.05311358720064163,
        -0.03180059790611267,
        -0.00538991391658783,
        0.022395169362425804,
        0.04749483987689018,
        0.06599928438663483,
      ]),
      f32x8::from_array([
        0.07610437273979187,
        0.07559116929769516,
        0.06401604413986206,
        0.04298238828778267,
        0.015254290774464607,
        -0.015227687545120716,
        -0.04399346932768822,
        -0.06659138202667236,
      ]),
      f32x8::from_array([
        -0.08063621073961258,
        -0.08333814144134521,
        -0.07382317632436752,
        -0.053428735584020615,
        -0.02485765889286995,
        0.007799659390002489,
        0.03973936662077904,
        0.06604408472776413,
      ]),
      f32x8::from_array([
        0.08378834277391434,
        0.0896591916680336,
        0.0823671743273735,
        0.0629609152674675,
        0.03403571620583534,
        -0.00023816860630176961,
        -0.0348053015768528,
        -0.06436675041913986,
      ]),
      f32x8::from_array([
        -0.08550682663917542,
        -0.09444613754749298,
        -0.08950184285640717,
        -0.07141580432653427,
        -0.04263140261173248,
        -0.007327391300350428,
        0.029275713488459587,
        0.061588089913129807,
      ]),
      f32x8::from_array([
        0.08576226979494095,
        0.09761708974838257,
        0.0951051190495491,
        0.07864875346422195,
        0.050497666001319885,
        0.014767584390938282,
        -0.023245202377438545,
        -0.05775563418865204,
      ]),
      f32x8::from_array([
        -0.08455029129981995,
        -0.09911777824163437,
        -0.09908110648393631,
        -0.08453600853681564,
        -0.05749989300966263,
        -0.02195509895682335,
        0.016816960647702217,
        0.05293495953083038,
      ]),
      f32x8::from_array([
        0.08189163357019424,
        0.09892253577709198,
        0.10136179625988007,
        0.08897681534290314,
        0.06351827830076218,
        0.028766950592398643,
        -0.01010098122060299,
        -0.04720855876803398,
      ]),
      f32x8::from_array([
        -0.07783178985118866,
        -0.09703470021486282,
        -0.10190815478563309,
        -0.0918952077627182,
        -0.06844985485076904,
        -0.03508659452199936,
        0.00321216881275177,
        0.04067440703511238,
      ]),
      f32x8::from_array([
        0.07244022190570831,
        0.09348657727241516,
        0.10071083903312683,
        0.09324125200510025,
        0.07221022993326187,
        0.04080589488148689,
        0.0037316035013645887,
        -0.03344430401921272,
      ]),
      f32x8::from_array([
        -0.06580918282270432,
        -0.08833887428045273,
        -0.09779033064842224,
        -0.092991903424263,
        -0.07473506778478622,
        -0.0458269938826561,
        -0.010611525736749172,
        0.02564196102321148,
      ]),
      f32x8::from_array([
        0.05805213004350662,
        0.08167966455221176,
        0.09319660067558289,
        0.09115144610404968,
        0.07598116993904114,
        0.05006398260593414,
        0.0173098836094141,
        -0.017400875687599182,
      ]),
      f32x8::from_array([
        -0.049301788210868835,
        -0.07362289726734161,
        -0.08700826019048691,
        -0.0877513661980629,
        -0.07592721283435822,
        -0.05344436690211296,
        -0.02371206507086754,
        0.008862055838108063,
      ]),
      f32x8::from_array([
        0.03970788046717644,
        0.06430642306804657,
        0.079331174492836,
        0.08284983038902283,
        0.07457412034273148,
        0.055910296738147736,
        0.02970852516591549,
        -0.00017160452262032777,
      ]),
      f32x8::from_array([
        -0.029434559866786003,
        -0.053889643400907516,
        -0.07029671967029572,
        -0.07653070986270905,
        -0.07194504141807556,
        -0.05741959065198898,
        -0.03519666567444801,
        -0.008521784096956253,
      ]),
      f32x8::from_array([
        0.018657604232430458,
        0.04255079850554466,
        0.06005945801734924,
        0.06890212744474411,
        0.0680849701166153,
        0.05794641748070717,
        0.04008258134126663,
        0.017069362103939056,
      ]),
      f32x8::from_array([
        -0.0075614131055772305,
        -0.030483897775411606,
        -0.048794567584991455,
        -0.06009460985660553,
        -0.06305994093418121,
        -0.057481762021780014,
        -0.04428267106413841,
        -0.025324877351522446,
      ]),
      f32x8::from_array([
        -0.0036641552578657866,
        0.01789540983736515,
        0.03669479116797447,
        0.05025885999202728,
        0.056955937296152115,
        0.056033581495285034,
        0.047725073993206024,
        0.03314707800745964,
      ]),
      f32x8::from_array([
        0.014827030710875988,
        -0.005000725854188204,
        -0.02396715246140957,
        -0.039563167840242386,
        -0.04987740144133568,
        -0.053626649081707,
        -0.05035088583827019,
        -0.0404021218419075,
      ]),
      f32x8::from_array([
        -0.025736209005117416,
        -0.00797952152788639,
        0.010829431004822254,
        0.02819053642451763,
        0.041945453733205795,
        0.05030215159058571,
        0.05211518332362175,
        0.04696587473154068,
      ]),
      f32x8::from_array([
        0.03620503470301628,
        0.02082323655486107,
        0.0024935852270573378,
        -0.016335558146238327,
        -0.033295806497335434,
        -0.04611697047948837,
        -0.05298777297139168,
        -0.052726030349731445,
      ]),
      f32x8::from_array([
        -0.04605438560247421,
        -0.0333106629550457,
        -0.015773937106132507,
        0.004201072268188,
        0.02407645620405674,
        0.04114271327853203,
        0.052953727543354034,
        0.05758402869105339,
      ]),
      f32x8::from_array([
        0.055115729570388794,
        0.045228131115436554,
        0.028784392401576042,
        0.0080052949488163,
        -0.014445152133703232,
        -0.035464491695165634,
        -0.05201362818479538,
        -0.061456743627786636,
      ]),
      f32x8::from_array([
        -0.06323403120040894,
        -0.05637173354625702,
        -0.041302334517240524,
        -0.020074686035513878,
        0.004566689021885395,
        0.029179466888308525,
        0.05018356442451477,
        0.06427792459726334,
      ]),
      f32x8::from_array([
        0.07027037441730499,
        0.06655080616474152,
        0.05311358720064163,
        0.03180059790611267,
        0.00538991391658783,
        -0.022395169362425804,
        -0.04749483987689018,
        -0.06599928438663483,
      ]),
      f32x8::from_array([
        -0.07610437273979187,
        -0.07559116929769516,
        -0.06401604413986206,
        -0.04298238828778267,
        -0.015254290774464607,
        0.015227687545120716,
        0.04399346932768822,
        0.06659138202667236,
      ]),
      f32x8::from_array([
        0.08063621073961258,
        0.08333814144134521,
        0.07382317632436752,
        0.053428735584020615,
        0.02485765889286995,
        -0.007799659390002489,
        -0.03973936662077904,
        -0.06604408472776413,
      ]),
      f32x8::from_array([
        -0.08378834277391434,
        -0.0896591916680336,
        -0.0823671743273735,
        -0.0629609152674675,
        -0.03403571620583534,
        0.00023816860630176961,
        0.0348053015768528,
        0.06436675041913986,
      ]),
      f32x8::from_array([
        0.08550682663917542,
        0.09444613754749298,
        0.08950184285640717,
        0.07141580432653427,
        0.04263140261173248,
        0.007327391300350428,
        -0.029275713488459587,
        -0.061588089913129807,
      ]),
      f32x8::from_array([
        -0.08576226979494095,
        -0.09761708974838257,
        -0.0951051190495491,
        -0.07864875346422195,
        -0.050497666001319885,
        -0.014767584390938282,
        0.023245202377438545,
        0.05775563418865204,
      ]),
      f32x8::from_array([
        0.08455029129981995,
        0.09911777824163437,
        0.09908110648393631,
        0.08453600853681564,
        0.05749989300966263,
        0.02195509895682335,
        -0.016816960647702217,
        -0.05293495953083038,
      ]),
      f32x8::from_array([
        -0.08189163357019424,
        -0.09892253577709198,
        -0.10136179625988007,
        -0.08897681534290314,
        -0.06351827830076218,
        -0.028766950592398643,
        0.01010098122060299,
        0.04720855876803398,
      ]),
      f32x8::from_array([
        0.07783178985118866,
        0.09703470021486282,
        0.10190815478563309,
        0.0918952077627182,
        0.06844985485076904,
        0.03508659452199936,
        -0.00321216881275177,
        -0.04067440703511238,
      ]),
      f32x8::from_array([
        -0.07244022190570831,
        -0.09348657727241516,
        -0.10071083903312683,
        -0.09324125200510025,
        -0.07221022993326187,
        -0.04080589488148689,
        -0.0037316035013645887,
        0.03344430401921272,
      ]),
      f32x8::from_array([
        0.06580918282270432,
        0.08833887428045273,
        0.09779033064842224,
        0.092991903424263,
        0.07473506778478622,
        0.0458269938826561,
        0.010611525736749172,
        -0.02564196102321148,
      ]),
      f32x8::from_array([
        -0.05805213004350662,
        -0.08167966455221176,
        -0.09319660067558289,
        -0.09115144610404968,
        -0.07598116993904114,
        -0.05006398260593414,
        -0.0173098836094141,
        0.017400875687599182,
      ]),
      f32x8::from_array([
        0.049301788210868835,
        0.07362289726734161,
        0.08700826019048691,
        0.0877513661980629,
        0.07592721283435822,
        0.05344436690211296,
        0.02371206507086754,
        -0.008862055838108063,
      ]),
      f32x8::from_array([
        -0.03970788046717644,
        -0.06430642306804657,
        -0.079331174492836,
        -0.08284983038902283,
        -0.07457412034273148,
        -0.055910296738147736,
        -0.02970852516591549,
        0.00017160452262032777,
      ]),
      f32x8::from_array([
        0.029434559866786003,
        0.053889643400907516,
        0.07029671967029572,
        0.07653070986270905,
        0.07194504141807556,
        0.05741959065198898,
        0.03519666567444801,
        0.008521784096956253,
      ]),
      f32x8::from_array([
        -0.018657604232430458,
        -0.04255079850554466,
        -0.06005945801734924,
        -0.06890212744474411,
        -0.0680849701166153,
        -0.05794641748070717,
        -0.04008258134126663,
        -0.017069362103939056,
      ]),
      f32x8::from_array([
        0.0075614131055772305,
        0.030483897775411606,
        0.048794567584991455,
        0.06009460985660553,
        0.06305994093418121,
        0.057481762021780014,
        0.04428267106413841,
        0.025324877351522446,
      ]),
      f32x8::from_array([
        0.0036641552578657866,
        -0.01789540983736515,
        -0.03669479116797447,
        -0.05025885999202728,
        -0.056955937296152115,
        -0.056033581495285034,
        -0.047725073993206024,
        -0.03314707800745964,
      ]),
      f32x8::from_array([
        -0.014827030710875988,
        0.005000725854188204,
        0.02396715246140957,
        0.039563167840242386,
        0.04987740144133568,
        0.053626649081707,
        0.05035088583827019,
        0.0404021218419075,
      ]),
      f32x8::from_array([
        0.025736209005117416,
        0.00797952152788639,
        -0.010829431004822254,
        -0.02819053642451763,
        -0.041945453733205795,
        -0.05030215159058571,
        -0.05211518332362175,
        -0.04696587473154068,
      ]),
      f32x8::from_array([
        -0.03620503470301628,
        -0.02082323655486107,
        -0.0024935852270573378,
        0.016335558146238327,
        0.033295806497335434,
        0.04611697047948837,
        0.05298777297139168,
        0.052726030349731445,
      ]),
      f32x8::from_array([
        0.04605438560247421,
        0.0333106629550457,
        0.015773937106132507,
        -0.004201072268188,
        -0.02407645620405674,
        -0.04114271327853203,
        -0.052953727543354034,
        -0.05758402869105339,
      ]),
      f32x8::from_array([
        -0.055115729570388794,
        -0.045228131115436554,
        -0.028784392401576042,
        -0.0080052949488163,
        0.014445152133703232,
        0.035464491695165634,
        0.05201362818479538,
        0.061456743627786636,
      ]),
      f32x8::from_array([
        0.06323403120040894,
        0.05637173354625702,
        0.041302334517240524,
        0.020074686035513878,
        -0.004566689021885395,
        -0.029179466888308525,
        -0.05018356442451477,
        -0.06427792459726334,
      ]),
      f32x8::from_array([
        -0.07027037441730499,
        -0.06655080616474152,
        -0.05311358720064163,
        -0.03180059790611267,
        -0.00538991391658783,
        0.022395169362425804,
        0.04749483987689018,
        0.06599928438663483,
      ]),
      f32x8::from_array([
        0.07610437273979187,
        0.07559116929769516,
        0.06401604413986206,
        0.04298238828778267,
        0.015254290774464607,
        -0.015227687545120716,
        -0.04399346932768822,
        -0.06659138202667236,
      ]),
      f32x8::from_array([
        -0.08063621073961258,
        -0.08333814144134521,
        -0.07382317632436752,
        -0.053428735584020615,
        -0.02485765889286995,
        0.007799659390002489,
        0.03973936662077904,
        0.06604408472776413,
      ]),
      f32x8::from_array([
        0.08378834277391434,
        0.0896591916680336,
        0.0823671743273735,
        0.0629609152674675,
        0.03403571620583534,
        -0.00023816860630176961,
        -0.0348053015768528,
        -0.06436675041913986,
      ]),
      f32x8::from_array([
        -0.08550682663917542,
        -0.09444613754749298,
        -0.08950184285640717,
        -0.07141580432653427,
        -0.04263140261173248,
        -0.007327391300350428,
        0.029275713488459587,
        0.061588089913129807,
      ]),
      f32x8::from_array([
        0.08576226979494095,
        0.09761708974838257,
        0.0951051190495491,
        0.07864875346422195,
        0.050497666001319885,
        0.014767584390938282,
        -0.023245202377438545,
        -0.05775563418865204,
      ]),
      f32x8::from_array([
        -0.08455029129981995,
        -0.09911777824163437,
        -0.09908110648393631,
        -0.08453600853681564,
        -0.05749989300966263,
        -0.02195509895682335,
        0.016816960647702217,
        0.05293495953083038,
      ]),
      f32x8::from_array([
        0.08189163357019424,
        0.09892253577709198,
        0.10136179625988007,
        0.08897681534290314,
        0.06351827830076218,
        0.028766950592398643,
        -0.01010098122060299,
        -0.04720855876803398,
      ]),
      f32x8::from_array([
        -0.07783178985118866,
        -0.09703470021486282,
        -0.10190815478563309,
        -0.0918952077627182,
        -0.06844985485076904,
        -0.03508659452199936,
        0.00321216881275177,
        0.04067440703511238,
      ]),
      f32x8::from_array([
        0.07244022190570831,
        0.09348657727241516,
        0.10071083903312683,
        0.09324125200510025,
        0.07221022993326187,
        0.04080589488148689,
        0.0037316035013645887,
        -0.03344430401921272,
      ]),
      f32x8::from_array([
        -0.06580918282270432,
        -0.08833887428045273,
        -0.09779033064842224,
        -0.092991903424263,
        -0.07473506778478622,
        -0.0458269938826561,
        -0.010611525736749172,
        0.02564196102321148,
      ]),
      f32x8::from_array([
        0.05805213004350662,
        0.08167966455221176,
        0.09319660067558289,
        0.09115144610404968,
        0.07598116993904114,
        0.05006398260593414,
        0.0173098836094141,
        -0.017400875687599182,
      ]),
      f32x8::from_array([
        -0.049301788210868835,
        -0.07362289726734161,
        -0.08700826019048691,
        -0.0877513661980629,
        -0.07592721283435822,
        -0.05344436690211296,
        -0.02371206507086754,
        0.008862055838108063,
      ]),
      f32x8::from_array([
        0.03970788046717644,
        0.06430642306804657,
        0.079331174492836,
        0.08284983038902283,
        0.07457412034273148,
        0.055910296738147736,
        0.02970852516591549,
        -0.00017160452262032777,
      ]),
    ];

    let mut fir_filter = FirFilter::new(Coefficients::new());
    let mut output: [f32x8; 96] = [f32x8::splat(0.); 96];
    for (i, x) in input.iter().enumerate() {
      output[i] = fir_filter.upsample(*x);
    }
    output.iter().zip(expected_output).for_each(|(a, b)| {
      a.to_array().iter().zip(b.to_array()).for_each(|(x, y)| {
        assert_approximately_eq(*x, y, 7);
      })
    })
  }

  #[test]
  fn should_downsample() {
    let input = [
      0.00000000e+00,
      -1.30526192e-01,
      2.58819045e-01,
      -3.82683432e-01,
      5.00000000e-01,
      -6.08761429e-01,
      7.07106781e-01,
      -7.93353340e-01,
      8.66025404e-01,
      -9.23879533e-01,
      9.65925826e-01,
      -9.91444861e-01,
      1.00000000e+00,
      -9.91444861e-01,
      9.65925826e-01,
      -9.23879533e-01,
      8.66025404e-01,
      -7.93353340e-01,
      7.07106781e-01,
      -6.08761429e-01,
      5.00000000e-01,
      -3.82683432e-01,
      2.58819045e-01,
      -1.30526192e-01,
      1.37197580e-14,
      1.30526192e-01,
      -2.58819045e-01,
      3.82683432e-01,
      -5.00000000e-01,
      6.08761429e-01,
      -7.07106781e-01,
      7.93353340e-01,
      -8.66025404e-01,
      9.23879533e-01,
      -9.65925826e-01,
      9.91444861e-01,
      -1.00000000e+00,
      9.91444861e-01,
      -9.65925826e-01,
      9.23879533e-01,
      -8.66025404e-01,
      7.93353340e-01,
      -7.07106781e-01,
      6.08761429e-01,
      -5.00000000e-01,
      3.82683432e-01,
      -2.58819045e-01,
      1.30526192e-01,
      -2.74395161e-14,
      -1.30526192e-01,
      2.58819045e-01,
      -3.82683432e-01,
      5.00000000e-01,
      -6.08761429e-01,
      7.07106781e-01,
      -7.93353340e-01,
      8.66025404e-01,
      -9.23879533e-01,
      9.65925826e-01,
      -9.91444861e-01,
      1.00000000e+00,
      -9.91444861e-01,
      9.65925826e-01,
      -9.23879533e-01,
      8.66025404e-01,
      -7.93353340e-01,
      7.07106781e-01,
      -6.08761429e-01,
      5.00000000e-01,
      -3.82683432e-01,
      2.58819045e-01,
      -1.30526192e-01,
      1.27375647e-14,
      1.30526192e-01,
      -2.58819045e-01,
      3.82683432e-01,
      -5.00000000e-01,
      6.08761429e-01,
      -7.07106781e-01,
      7.93353340e-01,
      -8.66025404e-01,
      9.23879533e-01,
      -9.65925826e-01,
      9.91444861e-01,
      -1.00000000e+00,
      9.91444861e-01,
      -9.65925826e-01,
      9.23879533e-01,
      -8.66025404e-01,
      7.93353340e-01,
      -7.07106781e-01,
      6.08761429e-01,
      -5.00000000e-01,
      3.82683432e-01,
      -2.58819045e-01,
      1.30526192e-01,
    ];
    let expected_output = [
      0.00000000e+00,
      -1.98802801e-03,
      -2.83260240e-03,
      1.48075988e-03,
      -8.28887840e-04,
      1.06889011e-04,
      4.23141705e-05,
    ];

    let input_as_simd: Vec<f32x8> = input
      .chunks_exact(8)
      .into_iter()
      .map(|x| f32x8::from_slice(x))
      .collect();
    let mut fir_filter = FirFilter::new(Coefficients::new());

    let mut output = [0.; 22];
    for (i, x) in input_as_simd.iter().enumerate() {
      output[i] = fir_filter.downsample(*x);
    }
    output.iter().zip(expected_output).for_each(|(a, b)| {
      assert_approximately_eq(*a, b, 7);
    })
  }
}
